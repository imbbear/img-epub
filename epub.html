<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ ¼å¼å›¾ç‰‡è½¬EPUBå·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .upload-section {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .preview-section {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 1.3rem;
            color: #3498db;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .drop-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8fafc;
            margin-bottom: 20px;
        }
        
        .drop-area:hover {
            background-color: #e8f4fc;
            border-color: #2980b9;
        }
        
        .drop-area.drag-over {
            background-color: #d4edff;
            border-color: #1abc9c;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-generate {
            background-color: #2ecc71;
            width: 100%;
            font-size: 1.1rem;
            padding: 15px;
            margin-top: 20px;
        }
        
        .btn-generate:hover {
            background-color: #27ae60;
        }
        
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .image-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .image-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .image-item:last-child {
            border-bottom: none;
        }
        
        .image-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
            border: 1px solid #ddd;
        }
        
        .image-info {
            flex: 1;
        }
        
        .image-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .image-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .image-size, .image-type {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-btn:hover {
            background-color: #c0392b;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .preview-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .preview-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        
        .svg-preview {
            width: 100%;
            height: 120px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #3498db;
        }
        
        .preview-index {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .preview-type {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .options {
            margin-top: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        .format-info {
            background-color: #e8f4f8;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .format-info h4 {
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .format-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .format-tag {
            background-color: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .instructions {
            background-color: #fff9e6;
            border-left: 4px solid #f1c40f;
            padding: 20px;
            margin-top: 30px;
            border-radius: 0 5px 5px 0;
        }
        
        .instructions h3 {
            color: #d35400;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>å¤šæ ¼å¼å›¾ç‰‡è½¬EPUBç”µå­ä¹¦å·¥å…·</h1>
        <p class="subtitle">æ”¯æŒJPEGã€PNGã€GIFã€WebPã€SVGæ ¼å¼å›¾ç‰‡ï¼Œä¸€é”®ç”ŸæˆEPUBç”µå­ä¹¦æ–‡ä»¶</p>
    </header>
    
    <div class="container">
        <div class="upload-section">
            <h2 class="section-title">1. ä¸Šä¼ å›¾ç‰‡</h2>
            <div class="drop-area" id="dropArea">
                <div class="upload-icon">ğŸ“</div>
                <p>æ‹–æ”¾å›¾ç‰‡æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <p><small>æ”¯æŒJPEGã€PNGã€GIFã€WebPã€SVGæ ¼å¼ï¼ŒæŒ‰é¡ºåºä¸Šä¼ å°†å†³å®šåœ¨EPUBä¸­çš„é¡ºåº</small></p>
                <input type="file" id="fileInput" class="file-input" accept=".jpg,.jpeg,.png,.gif,.webp,.svg,image/*" multiple>
                <button class="btn" id="selectFilesBtn">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</button>
            </div>
            
            <div class="image-list" id="imageList">
                <!-- å›¾ç‰‡åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                <p id="noFilesMessage" style="text-align: center; color: #7f8c8d; padding: 20px;">
                    å°šæœªé€‰æ‹©ä»»ä½•å›¾ç‰‡
                </p>
            </div>
            
            <div class="format-info">
                <h4>æ”¯æŒçš„å›¾ç‰‡æ ¼å¼</h4>
                <p>æœ¬å·¥å…·æ”¯æŒä»¥ä¸‹å›¾ç‰‡æ ¼å¼è½¬æ¢ä¸ºEPUBç”µå­ä¹¦ï¼š</p>
                <div class="format-list">
                    <span class="format-tag">JPEG (.jpg, .jpeg)</span>
                    <span class="format-tag">PNG (.png)</span>
                    <span class="format-tag">GIF (.gif)</span>
                    <span class="format-tag">WebP (.webp)</span>
                    <span class="format-tag">SVG (.svg)</span>
                </div>
            </div>
        </div>
        
        <div class="preview-section">
            <h2 class="section-title">2. é¢„è§ˆä¸è®¾ç½®</h2>
            <div class="preview-container" id="previewContainer">
                <!-- å›¾ç‰‡é¢„è§ˆå°†åŠ¨æ€ç”Ÿæˆ -->
                <p id="noPreviewMessage" style="text-align: center; color: #7f8c8d; padding: 20px; grid-column: 1 / -1;">
                    å›¾ç‰‡é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º
                </p>
            </div>
            
            <div class="options">
                <h2 class="section-title">3. EPUBè®¾ç½®</h2>
                <div class="form-group">
                    <label for="bookTitle">ç”µå­ä¹¦æ ‡é¢˜</label>
                    <input type="text" id="bookTitle" placeholder="è¯·è¾“å…¥ç”µå­ä¹¦æ ‡é¢˜" value="æˆ‘çš„å›¾ç‰‡ç”µå­ä¹¦">
                </div>
                
                <div class="form-group">
                    <label for="bookAuthor">ä½œè€…</label>
                    <input type="text" id="bookAuthor" placeholder="è¯·è¾“å…¥ä½œè€…åç§°" value="å›¾ç‰‡è½¬EPUBå·¥å…·">
                </div>
                
                <div class="form-group">
                    <label for="bookDescription">ç”µå­ä¹¦æè¿°</label>
                    <textarea id="bookDescription" placeholder="è¯·è¾“å…¥ç”µå­ä¹¦æè¿°">è¿™æ˜¯ä¸€æœ¬ç”±å¤šç§æ ¼å¼å›¾ç‰‡è½¬æ¢è€Œæˆçš„EPUBç”µå­ä¹¦ã€‚</textarea>
                </div>
                
                <div class="form-group">
                    <label for="imageQuality">å›¾ç‰‡è´¨é‡ (ä»…å¯¹JPEGæœ‰æ•ˆ)</label>
                    <input type="range" id="imageQuality" min="0.1" max="1" step="0.1" value="0.9">
                    <span id="qualityValue">0.9</span>
                </div>
                
                <button class="btn btn-generate" id="generateBtn" disabled>ç”ŸæˆEPUBç”µå­ä¹¦</button>
                
                <div class="status" id="statusMessage"></div>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <h3>ä½¿ç”¨æ­¥éª¤è¯´æ˜</h3>
        <ol>
            <li><strong>ä¸Šä¼ å›¾ç‰‡</strong>ï¼šç‚¹å‡»"é€‰æ‹©å›¾ç‰‡æ–‡ä»¶"æŒ‰é’®æˆ–æ‹–æ”¾å›¾ç‰‡æ–‡ä»¶åˆ°ä¸Šä¼ åŒºåŸŸï¼Œæ”¯æŒJPEGã€PNGã€GIFã€WebPã€SVGæ ¼å¼</li>
            <li><strong>è°ƒæ•´é¡ºåº</strong>ï¼šä¸Šä¼ çš„å›¾ç‰‡å°†æŒ‰é¡ºåºæ˜¾ç¤ºï¼Œæ‚¨å¯ä»¥é€šè¿‡åˆ é™¤é‡æ–°ä¸Šä¼ æ¥è°ƒæ•´é¡ºåº</li>
            <li><strong>å¡«å†™ä¿¡æ¯</strong>ï¼šè¾“å…¥ç”µå­ä¹¦çš„æ ‡é¢˜ã€ä½œè€…å’Œæè¿°ä¿¡æ¯</li>
            <li><strong>è®¾ç½®å›¾ç‰‡è´¨é‡</strong>ï¼šè°ƒæ•´JPEGå›¾ç‰‡çš„è´¨é‡ï¼ˆ0.1-1.0ï¼‰ï¼Œä»…å¯¹JPEGæ ¼å¼æœ‰æ•ˆ</li>
            <li><strong>ç”ŸæˆEPUB</strong>ï¼šç‚¹å‡»"ç”ŸæˆEPUBç”µå­ä¹¦"æŒ‰é’®ï¼Œç³»ç»Ÿå°†åˆ›å»ºå¹¶ä¸‹è½½EPUBæ–‡ä»¶</li>
            <li><strong>æ³¨æ„äº‹é¡¹</strong>ï¼šSVGæ ¼å¼å›¾ç‰‡å°†ä¿æŒçŸ¢é‡ç‰¹æ€§ï¼Œå…¶ä»–æ ¼å¼å›¾ç‰‡å°†ä¿æŒåŸå§‹è´¨é‡ã€‚EPUBæ–‡ä»¶æœ¬è´¨æ˜¯ZIPå‹ç¼©åŒ…ï¼Œå¯ä»¥å°†å…¶æ‰©å±•åæ”¹ä¸º.zipåè§£å‹æŸ¥çœ‹å†…éƒ¨ç»“æ„ã€‚</li>
            <li><strong>é‡æ–°ä¸Šä¼ </strong>ï¼šåˆ·æ–°é¡µé¢ï¼Œå°±å¯ä»¥é‡æ–°ä¸Šä¼ å›¾ç‰‡äº†</li>
        </ol>
    </div>
    
    <footer>
        <p>Â©HighSky 2026 å¤šæ ¼å¼å›¾ç‰‡è½¬EPUBå·¥å…· | æœ¬å·¥å…·å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œä¸ä¼šä¸Šä¼ æ‚¨çš„å›¾ç‰‡åˆ°ä»»ä½•æœåŠ¡å™¨</p>
    </footer>

    <script>
        // å…¨å±€å˜é‡
        let imageFiles = [];
        
        // DOMå…ƒç´ 
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const selectFilesBtn = document.getElementById('selectFilesBtn');
        const imageList = document.getElementById('imageList');
        const previewContainer = document.getElementById('previewContainer');
        const generateBtn = document.getElementById('generateBtn');
        const noFilesMessage = document.getElementById('noFilesMessage');
        const noPreviewMessage = document.getElementById('noPreviewMessage');
        const statusMessage = document.getElementById('statusMessage');
        const imageQuality = document.getElementById('imageQuality');
        const qualityValue = document.getElementById('qualityValue');
        
        // æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
        const supportedFormats = {
            'jpg': 'image/jpeg',
            'jpeg': 'image/jpeg',
            'png': 'image/png',
            'gif': 'image/gif',
            'webp': 'image/webp',
            'svg': 'image/svg+xml'
        };
        
        // äº‹ä»¶ç›‘å¬
        selectFilesBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        generateBtn.addEventListener('click', generateEPUB);
        imageQuality.addEventListener('input', () => {
            qualityValue.textContent = imageQuality.value;
        });
        
        // æ‹–æ”¾åŠŸèƒ½
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('drag-over');
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('drag-over');
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files).filter(file => 
                isImageFile(file)
            );
            
            if (files.length > 0) {
                addImageFiles(files);
            } else {
                showStatus('è¯·æ‹–æ”¾æ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶æ ¼å¼', 'error');
            }
        });
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºæ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶
        function isImageFile(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            return supportedFormats.hasOwnProperty(extension) || 
                   file.type.startsWith('image/');
        }
        
        // è·å–æ–‡ä»¶ç±»å‹
        function getFileType(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            if (supportedFormats[extension]) {
                return supportedFormats[extension];
            }
            return file.type;
        }
        
        // è·å–æ–‡ä»¶æ‰©å±•å
        function getFileExtension(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            if (supportedFormats.hasOwnProperty(extension)) {
                return extension;
            }
            // ä»MIMEç±»å‹æ¨æ–­æ‰©å±•å
            if (file.type === 'image/jpeg') return 'jpg';
            if (file.type === 'image/png') return 'png';
            if (file.type === 'image/gif') return 'gif';
            if (file.type === 'image/webp') return 'webp';
            if (file.type === 'image/svg+xml') return 'svg';
            return 'img';
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addImageFiles(files);
        }
        
        // æ·»åŠ å›¾ç‰‡æ–‡ä»¶
        function addImageFiles(files) {
            // è¿‡æ»¤åªä¿ç•™æ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶
            const imageFilesFiltered = files.filter(file => 
                isImageFile(file)
            );
            
            if (imageFilesFiltered.length === 0) {
                showStatus('è¯·é€‰æ‹©æ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶æ ¼å¼ (JPEG, PNG, GIF, WebP, SVG)', 'error');
                return;
            }
            
            // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
            imageFiles.push(...imageFilesFiltered);
            updateUI();
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
            fileInput.value = '';
        }
        
        // ç§»é™¤å›¾ç‰‡æ–‡ä»¶
        function removeImageFile(index) {
            imageFiles.splice(index, 1);
            updateUI();
        }
        
        // æ›´æ–°UI
        function updateUI() {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            generateBtn.disabled = imageFiles.length === 0;
            
            // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
            if (imageFiles.length === 0) {
                noFilesMessage.style.display = 'block';
                imageList.innerHTML = '';
                imageList.appendChild(noFilesMessage);
            } else {
                noFilesMessage.style.display = 'none';
                
                let listHTML = '';
                imageFiles.forEach((file, index) => {
                    const fileType = getFileType(file);
                    const fileExtension = getFileExtension(file);
                    
                    listHTML += `
                    <div class="image-item">
                        <img src="${URL.createObjectURL(file)}" alt="${file.name}" class="image-preview">
                        <div class="image-info">
                            <div class="image-name">${file.name}</div>
                            <div class="image-details">
                                <div class="image-size">${formatFileSize(file.size)}</div>
                                <div class="image-type">${fileExtension.toUpperCase()}</div>
                            </div>
                        </div>
                        <button class="remove-btn" onclick="removeImageFile(${index})">Ã—</button>
                    </div>
                    `;
                });
                imageList.innerHTML = listHTML;
            }
            
            // æ›´æ–°é¢„è§ˆ
            if (imageFiles.length === 0) {
                noPreviewMessage.style.display = 'block';
                previewContainer.innerHTML = '';
                previewContainer.appendChild(noPreviewMessage);
            } else {
                noPreviewMessage.style.display = 'none';
                
                let previewHTML = '';
                imageFiles.forEach((file, index) => {
                    const fileExtension = getFileExtension(file);
                    const isSVG = fileExtension === 'svg';
                    
                    previewHTML += `
                    <div class="preview-item">
                        ${isSVG ? 
                            `<div class="svg-preview">SVG</div>` : 
                            `<img src="${URL.createObjectURL(file)}" alt="é¢„è§ˆ ${index + 1}" class="preview-img">`
                        }
                        <div class="preview-index">${index + 1}</div>
                        <div class="preview-type">${fileExtension.toUpperCase()}</div>
                    </div>
                    `;
                });
                previewContainer.innerHTML = previewHTML;
            }
        }
        
        // ç”ŸæˆEPUB
        async function generateEPUB() {
            if (imageFiles.length === 0) {
                showStatus('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error');
                return;
            }
            
            showStatus('æ­£åœ¨ç”ŸæˆEPUBæ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'success');
            generateBtn.disabled = true;
            
            try {
                // åˆ›å»ºZIPæ–‡ä»¶ï¼ˆEPUBæœ¬è´¨ä¸Šæ˜¯ZIPï¼‰
                const zip = new JSZip();
                
                // æ·»åŠ mimetypeæ–‡ä»¶ï¼ˆEPUBæ ‡å‡†è¦æ±‚ï¼‰
                zip.file("mimetype", "application/epub+zip");
                
                // åˆ›å»ºMETA-INFæ–‡ä»¶å¤¹å¹¶æ·»åŠ container.xml
                const metaInf = zip.folder("META-INF");
                metaInf.file("container.xml", `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);
                
                // åˆ›å»ºOEBPSæ–‡ä»¶å¤¹ï¼ˆå­˜æ”¾ä¸»è¦å†…å®¹ï¼‰
                const oebps = zip.folder("OEBPS");
                
                // åˆ›å»ºå†…å®¹æ–‡ä»¶
                const bookTitle = document.getElementById('bookTitle').value || "æˆ‘çš„å›¾ç‰‡ç”µå­ä¹¦";
                const bookAuthor = document.getElementById('bookAuthor').value || "å›¾ç‰‡è½¬EPUBå·¥å…·";
                const bookDescription = document.getElementById('bookDescription').value || "è¿™æ˜¯ä¸€æœ¬ç”±å¤šç§æ ¼å¼å›¾ç‰‡è½¬æ¢è€Œæˆçš„EPUBç”µå­ä¹¦ã€‚";
                const quality = parseFloat(imageQuality.value);
                
                // åˆ›å»ºcontent.opfæ–‡ä»¶
                let manifestItems = '';
                let spineItems = '';
                let guideItems = '';
                
                // ä¸ºæ¯å¼ å›¾ç‰‡åˆ›å»ºHTMLæ–‡ä»¶
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    const fileExtension = getFileExtension(file);
                    const mediaType = getFileType(file);
                    const fileName = `image_${i + 1}.html`;
                    const imageName = `image_${i + 1}.${fileExtension}`;
                    
                    // å¤„ç†å›¾ç‰‡æ•°æ®
                    let imageData;
                    
                    // å¯¹äºJPEGå›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œè´¨é‡å‹ç¼©
                    if (fileExtension === 'jpg' || fileExtension === 'jpeg') {
                        imageData = await compressJPEG(file, quality);
                    } else {
                        // å…¶ä»–æ ¼å¼ä¿æŒåŸæ ·
                        imageData = await fileToArrayBuffer(file);
                    }
                    
                    // å°†å›¾ç‰‡æ·»åŠ åˆ°ZIP
                    oebps.file(imageName, imageData);
                    
                    // åˆ›å»ºHTMLå†…å®¹
                    const htmlContent = `<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>${bookTitle} - ç¬¬${i + 1}é¡µ</title>
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      text-align: center; 
      background-color: #000; 
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    img, svg, object { 
      max-width: 100%; 
      max-height: 100vh; 
      height: auto; 
      width: auto;
    }
  </style>
</head>
<body>
  ${fileExtension === 'svg' ? 
    `<object data="${imageName}" type="image/svg+xml" width="100%" height="100%"></object>` :
    `<img src="${imageName}" alt="ç¬¬${i + 1}é¡µ"/>`
  }
</body>
</html>`;
                    
                    oebps.file(fileName, htmlContent);
                    
                    // æ·»åŠ åˆ°manifest
                    manifestItems += `    <item id="image${i + 1}" href="${imageName}" media-type="${mediaType}"/>\n`;
                    manifestItems += `    <item id="page${i + 1}" href="${fileName}" media-type="application/xhtml+xml"/>\n`;
                    
                    // æ·»åŠ åˆ°spine
                    spineItems += `    <itemref idref="page${i + 1}"/>\n`;
                    
                    // ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºå°é¢
                    if (i === 0) {
                        guideItems += `    <reference type="cover" title="å°é¢" href="${fileName}"/>\n`;
                    }
                }
                
                // åˆ›å»ºç›®å½•æ–‡ä»¶
                const tocHtml = `<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>ç›®å½•</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { color: #333; }
    .format-info {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    ol { list-style-type: none; padding-left: 0; }
    li { 
      padding: 10px 0; 
      border-bottom: 1px solid #eee; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .page-link { 
      color: #0066cc; 
      text-decoration: none; 
      flex: 1;
    }
    .page-link:hover { text-decoration: underline; }
    .page-format {
      background-color: #f0f0f0;
      color: #666;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <h1>${bookTitle}</h1>
  <div class="format-info">å…± ${imageFiles.length} å¼ å›¾ç‰‡</div>
  <ol>
${imageFiles.map((file, i) => {
  const ext = getFileExtension(file).toUpperCase();
  return `    <li>
      <a class="page-link" href="image_${i + 1}.html">ç¬¬ ${i + 1} é¡µ</a>
      <span class="page-format">${ext}</span>
    </li>`;
}).join('\n')}
  </ol>
</body>
</html>`;
                
                oebps.file("toc.html", tocHtml);
                
                // åˆ›å»ºcontent.opfæ–‡ä»¶
                const opfContent = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="bookid">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:identifier id="bookid">urn:uuid:${generateUUID()}</dc:identifier>
    <dc:title>${bookTitle}</dc:title>
    <dc:creator>${bookAuthor}</dc:creator>
    <dc:language>zh-CN</dc:language>
    <dc:description>${bookDescription}</dc:description>
    <meta property="dcterms:modified">${new Date().toISOString().split('.')[0]+"Z"}</meta>
  </metadata>
  <manifest>
    <item id="toc" href="toc.html" media-type="application/xhtml+xml"/>
${manifestItems}    <item id="nav" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
  </manifest>
  <spine toc="nav">
${spineItems}  </spine>
  <guide>
${guideItems}  </guide>
</package>`;
                
                oebps.file("content.opf", opfContent);
                
                // åˆ›å»ºç›®å½•å¯¼èˆªæ–‡ä»¶
                const tocNcx = `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="urn:uuid:${generateUUID()}"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
  </head>
  <docTitle>
    <text>${bookTitle}</text>
  </docTitle>
  <docAuthor>
    <text>${bookAuthor}</text>
  </docAuthor>
  <navMap>
${imageFiles.map((file, i) => {
  const ext = getFileExtension(file).toUpperCase();
  return `    <navPoint id="nav${i + 1}" playOrder="${i + 1}">
      <navLabel>
        <text>ç¬¬ ${i + 1} é¡µ (${ext})</text>
      </navLabel>
      <content src="image_${i + 1}.html"/>
    </navPoint>`;
}).join('\n')}
  </navMap>
</ncx>`;
                
                oebps.file("toc.ncx", tocNcx);
                
                // ç”ŸæˆZIPæ–‡ä»¶
                const zipBlob = await zip.generateAsync({type: "blob"});
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(zipBlob);
                downloadLink.download = `${bookTitle.replace(/[^\w\u4e00-\u9fa5]/g, '_')}.epub`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                showStatus(`EPUBæ–‡ä»¶ç”ŸæˆæˆåŠŸï¼å·²ä¸‹è½½ä¸º"${downloadLink.download}"`, 'success');
            } catch (error) {
                console.error('ç”ŸæˆEPUBæ—¶å‡ºé”™:', error);
                showStatus('ç”ŸæˆEPUBæ—¶å‡ºé”™ï¼š' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
            }
        }
        
        // JPEGå›¾ç‰‡å‹ç¼©
        async function compressJPEG(file, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob(function(blob) {
                            const reader = new FileReader();
                            reader.onload = function() {
                                resolve(reader.result);
                            };
                            reader.onerror = reject;
                            reader.readAsArrayBuffer(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // å·¥å…·å‡½æ•°ï¼šæ–‡ä»¶å¤§å°æ ¼å¼åŒ–
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status ' + type;
        }
        
        // å·¥å…·å‡½æ•°ï¼šå°†æ–‡ä»¶è½¬æ¢ä¸ºArrayBuffer
        function fileToArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // å·¥å…·å‡½æ•°ï¼šç”ŸæˆUUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // åˆå§‹åŒ–
        updateUI();
    </script>
    
    <!-- å¼•å…¥JSZipåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>